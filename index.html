<!DOCTYPE html>
<html>
<head>
    <title>Isochrones Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        #map {
            width: 100%;
            height: 100vh;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialisation de la carte
            var map = L.map('map').setView([46.2557, 5.2523], 10);

            // Ajouter une couche de carte (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Créer différents panes pour contrôler l'ordre des couches
            map.createPane('pane30'); // De 15 à 30 minutes
            map.createPane('pane15'); // De 5 à 15 minutes
            map.createPane('pane5'); // Moins de 5 minutes
            map.createPane('paneMarkers'); // Pane for markers and labels
            


            // Fonction pour ajouter un isochrone à la carte
            function addIsochrone(coordinates, color, pane) {
                var latlngs = coordinates.map(function(coord) {
                    return [coord[1], coord[0]]; // Correction de l'ordre des coordonnées
                });

                L.polygon(latlngs, {
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.5, // Opacité de remplissage
                    opacity: 1, // Opacité de contour
                    weight: 1,
                    pane: pane // Assigner le pane approprié
                }).addTo(map);
            }

            // Charger et afficher les isochrones
            async function loadIsochrones() {
                try {
                    const response = await fetch('test7.json');
                    const data = await response.json();
                    console.log(data);

                    // Itérer sur chaque entité
                    data.features.forEach(function(feature) {
                        const contour = feature.properties.time;
                        let color, pane;
                        if (contour === 30) {
                            color = '#FF0000'; // Red for 15 to 30 minutes
                            pane = 'pane30';
                        } else if (contour === 15) {
                            color = '#FFFF00'; // Yellow for 5 to 15 minutes
                            pane = 'pane15';
                        } else if (contour === 5) {
                            color = '#00FF00'; // Green for less than 5 minutes
                            pane = 'pane5';
                        }
                        feature.geometry.coordinates.forEach(polygon => {
                            polygon.forEach(coordinates => {
                                addIsochrone(coordinates, color, pane);
                            });
                        });
                    });

                } catch (error) {
                    console.error('Error loading isochrones:', error);
                }
            }

            // Charger les isochrones au démarrage
            loadIsochrones();

            async function loadXLSX() {
                const response = await fetch('data-es.xlsx'); // Remplacez cette URL par le chemin de votre fichier
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });

                // Supposons que les données se trouvent dans la première feuille
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                // Affichage des marqueurs et des étiquettes sur la carte
                jsonData.forEach(item => {
                    const lat = item.Latitude;
                    const lng = item.Longitude;
                    const installation = item.Installation;
                    const equipment = item.Equipement;

                    // Ajouter un marqueur pour chaque point
                    L.circleMarker([lat, lng], {
                        color: 'blue',
                        radius: 1.5,
                        pane: 'paneMarkers'
                    }).addTo(map)
                    .bindPopup(`<b>${installation}</b><br>${equipment}`);

  
                });
            }

            // Charger et afficher les données XLSX au démarrage
            loadXLSX();
        });
    </script>
</body>
</html>
